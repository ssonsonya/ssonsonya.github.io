---
layout: post
title: UE4(BP & C++) FootIK 적용
date: 2023-10-12
category: 
 - challenge
tag:
 - 1|FootIK
 - 1|IKComponent
 - 1|Footstep
 - 1|UStruct
 - 1|Animation

thumbnail: /style/image/challenge_thumbnails/FootIK.png
icon: idea
---
IKComponent를 통해 Character의 발바닥과 지형이 자연스럽게 맞닿을 수 있도록 FootIK 적용하기

![DiffIK](https://github.com/ssonsonya/ssonsonya.github.io/assets/116151781/417c0b8f-5b6e-4a1f-940a-8a2d2800b860)

* content
{:toc}

## 요약 
- 주요 목표 : 지형과 어우러지는 움직임을 위해 FootIK 적용하기
- 해결 방안 : 지면과 Foot의 위치와 각도 차이를 추가한 Socket에서 지면을 향한 실시간 수직 `Line Trace`로 반환받아 ABP에서 `Bone Transform`과 `2 Bone IK`함수로 하체 주요 Bone에 적용
- 이루어낸 성과 :
    1. 각기 다른 CharacterMesh의 구성에 따른 오차에도 일괄 적용가능한 IKComponent 구현
    2. `Bone Transform`과 `2 Bone IK`에 대한 이해 
    3. 계단 또는 굴곡있는 지형에 잘 어우러지는 캐릭터 움직임 구현

```
PPT로 한장정리
1. FootIK 적용 그림이미지
2. 순서이미지(BP / CPP)
3. ABP
```

---

## Blueprint IKComponent

FootIK의 개념과 구현방법은 [Ryan Laley의 YouTube 채널 IK시리즈](https://www.youtube.com/watch?v=dpteQzWMbfQ) [^21] 를 참고했고, 사용하는 Mannequin의 height 등 Mesh Asset의 기본값으로 인한 오차를 최소화하기 위해 변수를 다르게 적용했다  
![image](https://github.com/ssonsonya/ssonsonya.github.io/assets/116151781/4b601957-65a6-4f9b-8b58-22e6b0c09832)

캐릭터가 공중에 떠있는 상태가 아닌경우에만 FootIK가 적용되도록 `Branch`를 걸어준 뒤 `SetIK`함수를 `Tick`마다 호출  

### LineTrace

+ Input
    - `InSocketName` : `LineTrace`를 시작할 Socket의 이름  
    
+ Return
    - `FootTraceZ` : Socket과 지면의 거리(높이) 차이
    - `FootRot` : 맞닿은 지면의 `Normal Vector`를 역각으로 계산한 Rotation값

**Fullscreen또는 Ctrl+마우스휠로 ZoomIn/Out 가능*
<iframe width="100%" height="400" src="https://blueprintue.com/render/cnwk49p0/" scrolling="no" allowfullscreen></iframe>

1. `Foot`본에서부터 하단수직방향으로 `Max Step Height`만큼 `LineTrace`
2. Hit가 `false`일 땐 초기값(0) 반환
3. Hit된 `Impact Point`벡터에서 캐릭터 `Mesh`의 위치까지 거리벡터를 구한 뒤 `Height`가 될 `Z`값을 `FootTraceZ`로 반환
4. 


### SetIK
**Fullscreen또는 Ctrl+마우스휠로 ZoomIn/Out 가능*
<iframe width="100%" height="400" src="https://blueprintue.com/render/tz_2_45z/" scrolling="no" allowfullscreen></iframe>

---

## C++ IKComponent

```c++
// CFootIKComponent.h
#pragma once
#include "CoreMinimal.h"
#include "Components/ActorComponent.h"
#include "Kismet/KismetSystemLibrary.h"
#include "CIKComponent.generated.h"

USTRUCT(BlueprintType)
struct FFootIKData
{
    GENERATED_BODY()
public:
    UPROPERTY(BlueprintReadOnly, Category = "FootIK")
        FVector IKEffector_L;
    UPROPERTY(BlueprintReadOnly, Category = "FootIK")
        FVector IKEffector_R;
    UPROPERTY(BlueprintReadOnly, Category = "FootIK")
        FVector DisplacementZ;
        
    UPROPERTY(BlueprintReadOnly, Category = "FootIK")
        FRotator Rot_L;
    UPROPERTY(BlueprintReadOnly, Category = "FootIK")
        FRotator Rot_R;
};

UCLASS( ClassGroup=(Custom), meta=(BlueprintSpawnableComponent) )
class U06_BATTLE_API UCIKComponent : public UActorComponent
{
    GENERATED_BODY()
public:
    UCIKComponent();
protected:
    virtual void BeginPlay() override;
public:	
    virtual void TickComponent(float DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction) override;

private:    // Functions
    void LineTrace(FName InSocketName, float& OutFootTraceZ, FRotator& OutFootRot);

public:     // Inline
    FORCEINLINE FFootIKData GetData() { return FootIKData; }

private:    // UProperty Members
    UPROPERTY(EditAnywhere, Category = "LineTrace")
        TEnumAsByte<EDrawDebugTrace::Type> DrawDebug;
    UPROPERTY(EditAnywhere, Category = "LineTrace")
        float Displacement = 0.0f;
    UPROPERTY(EditAnywhere, Category = "LineTrace")
        float LFootEffector = 50.0f;
    UPROPERTY(EditAnywhere, Category = "TraLineTracece")
        float RFootEffector = 5.0f;
    UPROPERTY(EditAnywhere, Category = "LineTrace")
        FName LeftSocketName = "Foot_L_IK";
    UPROPERTY(EditAnywhere, Category = "LineTrace")
        FName RightSocketName = "Foot_R_IK";

private:    // Private Members
    class ACharacter* OwnerCharacter;
    FFootIKData FootIKData;
    float InterpSpeed = 10.0f;
};
```

```c++
// CFootIKComponent.cpp
#include "02_Components/CFootIKComponent.h"
#include "Global.h" // Utilities
#include "GameFramework/Character.h"
#include "Components/SkeletalMeshComponent.h"
#include "Components/CapsuleComponent.h"

#define LOG_UCFeetComponent

UCFootIKComponent::UCFootIKComponent()
{
    PrimaryComponentTick.bCanEverTick = true;
}

void UCFootIKComponent::BeginPlay()
{
    Super::BeginPlay();
    OwnerCharacter = Cast<ACharacter>(GetOwner());
}
```

### LineTrace

```c++
// CFootIKComponent.cpp
void UCFootIKComponent::LineTrace(FName InSocketName, float& OutFootTraceZ, FRotator& OutFootRot)
{
    // Trace Start
    FVector start = OwnerCharacter->GetMesh()->GetSocketLocation(InSocketName);

    // Trace End
    FVector meshLocation = OwnerCharacter->GetMesh()->GetWorldLocation();
    float z = meshLocation.Z - OwnerCharacter->GetCharacterMovementComponent().MaxStepHeight;
    FVector end = FVector(socketLocation.X, socketLocation.Y, z);

    // LineTrace
    TArray<AActor*> ignores;
    ignores.Add(OwnerCharacter);
    FHitResult hitResult;
    
    UKismetSystemLibrary::LineTraceSingle(GetWorld(), start, end, ETraceTypeQuery::TraceTypeQuery1, true, ignores, DrawDebug, hitResult, true,FLinearColor::Green, FLinearColor::Red);
    
    // Init Outputs
    OutFootTraceZ = 0.0f;
    OutFootRot = FRotator::ZeroRotator;
    
    // Check Validity
    CheckFalse(hitResult.bBlockingHit);
    
    // OutFootTraceZ
    FVector distance = (hitResult.ImpactPoint - OwnerCharacter->GetMesh()->GetWorldLocation());
    OutFootTraceZ = distance.Z;

    // OutFootRot
    float roll = UKismetMathLibrary::DegAtan2(hitResult.Normal.Y, hitResult.Normal.Z);
    float pitch = UKismetMathLibrary::DegAtan2(hitResult.Normal.X, hitResult.Normal.Z) * -1.0f;	// -1 to Rotate in opposite direction
    OutRotation = FRotator(pitch, 0, roll);
}
```

### Tick(SetIK)

```c++
// CFootIKComponent.cpp
void UCFootIKComponent::TickComponent(float DeltaTime, ELevelTick TickType, FActorComponentTickFunction* ThisTickFunction)
{
    Super::TickComponent(DeltaTime, TickType, ThisTickFunction);
    
    // Check isFalling
    CheckFalse(OwnerCharacter->GetCharacterMovementComponent()->IsFalling());

    // Temp Variables
    float leftTrace;
    float rightTrace;
    float displacement;
    FRotator leftRot;
    FRotator rightRot;
    
    // LineTrace from both Sockets
    // Left Foot
    LineTrace(LeftSocketName, leftTrace, leftRot);
    
    FootIKData.IKEffector_L.X = UKismetMathLibrary::FInterpTo(FootIKData.IKEffector_L.X, leftTrace, DeltaTime, InterpSpeed);
    FootIKData.Rot_L = UKismetMathLibrary::RInterpTo(FootIKData.Rot_L, leftRot, DeltaTime, InterpSpeed);
    
    // Right Foot
    LineTrace(RightSocketName, rightTrace, rightRot);
    
    FootIKData.IKEffector_R.X = UKismetMathLibrary::FInterpTo(FootIKData.IKEffector_R.X, -rightTrace, DeltaTime, InterpSpeed); // -rightTrace due to opposite bone direction
    FootIKData.Rot_R = UKismetMathLibrary::RInterpTo(FootIKData.Rot_R, rightRot, DeltaTime, InterpSpeed);
    
    // Pelvis
    displacement = FMath::Max(Abs(leftTrace), Abs(rightTrace));
    
    FootIKData.DisplacementZ.Z = UKismetMathLibrary::FInterpTo(FootIKData.DisplacementZ.Z, displacement, DeltaTime, InterpSpeed);

#ifdef  LOG_UCFootIKComponent
	CLog::Print(FootIKData.DisplacementZ, 11);
	CLog::Print(FootIKData.IKEffector_L, 12);
	CLog::Print(FootIKData.Rot_L, 13);
	CLog::Print(FootIKData.IKEffector_R, 14);
	CLog::Print(FootIKData.Rot_R, 15);
#endif // LOG_UCFootIKComponent
}
```
---

## ABP IKLayer

![image](https://github.com/ssonsonya/ssonsonya.github.io/assets/116151781/33d11c9d-46fc-46a3-8338-8ec0e0250739)

---

## Reference

[^21]: [Ryan Laley(2020.09.09).YouTube. Unreal Engine 4 Tutorial - IK Part 1 - Understanding IK](https://www.youtube.com/watch?v=dpteQzWMbfQ)