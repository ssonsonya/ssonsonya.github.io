---
layout: post
title: UE4 에디터에서 신년 해돋이를 보는 방법
date: 2023-12-31
category: 
 - challenge
tag:
 - 1|Blueprint
 - 1|SkySphere
 - 1|DirectionalLight
 - 1|Now
 - 1|ColorCurve
thumbnail: /style/image/challenge_thumbnails/24hSky.png
icon: idea
---

해뜨는 줄 모르고 작업했지만 신년 해돋이는 보고싶어 SkySphere에 실시간 반영되는 하늘을 연출해보았다
![24hourSky](https://github.com/ssonsonya/ssonsonya.github.io/assets/116151781/a63233b1-8647-4216-bbb2-e0122217c5e9)

* content
{:toc}

## 요약 
- 주요 목표 : 실시간 태양의 고도와 석양/노을 연출하기
- 해결 방안 : SkySphere 액터에서 Light Source 액터를 Now함수로 반환받는 시간단위로 Y축 회전
- 이루어낸 성과 :
    1. 엔진콘텐츠의 애셋 내 입맛대로 커스터마이징하기 실천
    2. SkySphere의 구현방식 이해
    3. 이후 작업하면서 하늘시간 체감 가능

```
PPT로 한장정리
1. 엔진 콘텐츠 BP_SkySphere 파헤치기
2. Now함수를 통해 실시간 고도 계산
3. ColorCurve 조율로 노을/일출 표현
```

---

## Engine Contents
![image](https://github.com/ssonsonya/ssonsonya.github.io/assets/116151781/e68cc30d-0073-4d51-8f2c-b220d928bd16)
엔진콘텐츠의 SkySphere액터는 기본 Map에 배치된 상태로 생성된다  
`BP_SkySphere`는 8,192cm지름의 구체에 param값으로 해, 구름, 대기의 색깔, 그리고 별표현을 가능하게 해주는 Material `M_Sky_Panning_Clouds2`를 입힌 `SM_SkySphere`로 이루어져 있다

### BP_SkySphere
`BP_SkySphere`를 Map에 배치한 뒤 Default 항목 중 Directional Light Actor에 Map에 배치된 `DirectionalLight` 액터를 지정해주면 해당 광원을 햇빛으로 설정해 줄 수 있다  
광원의 Rotation을 바꾸고 `BP_SkySphere`의 `Refresh Material` bool을 체크해주면 `Refresh Material` 함수가 호출되며 해당 Rotation값에 맞춰진 해와 대기가 표현된다  
![BP_SkySphere](https://github.com/ssonsonya/ssonsonya.github.io/assets/116151781/dd8d3b31-4b77-49df-81f7-ba68bb9e1a80)

### Refresh Material
`BP_SkySphere`의 Deafult 변수 `Refresh Material`이 true일 때 호출되어  
지정된 광원이 있을 때 해당 원의 Pitch값을 `Sun Height`(태양의 고도)에 계산해 `M_Sky_Panning_Clouds2`에 적용해주는 함수이다  
시간대 광원 각도에 따른 param값 적용은 아래와 같다  

| 구분 | 광원 (Pitch) | Sun Height | Time | Horizon Falloff |
| :---: | :---: | :---: | :---: | :---: |
| 내용 | Directional Light | 태양의 고도 |  Color Curve의 Time 축 | 지평선 색상지수  |
| 범위 | 0 ~ 360˚ | -1.0 ~ 1.0 (Map Range) | -1.0 ~ 1.0 | 3.0 ~ 7.0 (Lerp) |
| 일출 | 0.0˚ | 0.0 | 0.0 | 3.0 |
| 정오 | -90.0˚ | 1.0 | 1.0 | 7.0 |
| 일몰 | -180.0˚ | 1.0 | 1.0 | 7.0 |
| 자정 | 90.0˚ | -1.0 | -1.0 | 7.0 |

---

## BP_RealTimeSky

<iframe width="100%" height="400" src="https://blueprintue.com/render/7lkfzygg/" scrolling="no" allowfullscreen></iframe>

### LightSource Setting

### ☀️Now

[언리얼의 `Now` 함수는 PC의 로컬 시간을 반환해주는 함수이다](https://docs.unrealengine.com/4.26/en-US/API/Runtime/Core/Misc/FDateTime/Now/) [^21]  
반환값 year / month / day / hour / minute / second / millisecond 중 `hour` `minute` `second` `millisecond`로  
Tick 마다 `Light Source`로 지정해둔 `DirectionalLight`액터의 Y축 회전값에 반영해 주면 시간별 태양의 고도를 연출할 수 있다  
Dx2D 공부할 당시 아날로그 시계를 구현하는 방식과 동일하게 시, 분, 초, 밀리초를 계산해주었다  

Light Source의 위치를 중심으로 하루 24시간을 360˚ Pitch회전 시 빛의 방향을 바라보며 SkySphere에 태양이 위치하게 되기 때문에  
- 시간 : 매 시간 1/24 * 360 = 15˚씩 회전한다고 볼 수 있고 이런식으로  
- 분 : 매 15도를 60분씩 회전하니 1/(24 * 60) * 360 = 0.25˚  
- 초 : 1/(24 * 60 * 60) * 360 = 0.0416˚  
- 밀리초 : 1/(24 * 60 * 60 * 1000) * 360 = 0.000004˚  

이렇게 회전값이 누적되어야 하니 이 모든 숫자들을 더해준다  
마지막으로 Y회전값이 -90˚일 때 햇빛이 지면에 수직으로 닿기 때문에, 초기값에 +90˚ 해주면 00시일때 햇빛의 방향이 수직으로 향하게 하는 가장 어두운 시간을 나타낼 수 있다  

다른 변수들은 무시하고 낮의길이를 12시간으로 가정하고, 2024년 1월 1일 예상 일출 시간 [오전 7시 47분](https://www.kasi.re.kr/kor/publication/post/newsMaterial/29876) [^22]  
(7/24) + (47/(24*60)) = 12.04˚를 더해주면 일출시간을 0˚로 맞출 수 있다

### Color Curve

### Other Settings


---

## 생각정리

---

## Reference

[^21]: [Unreal Engine. Documentation. FDateTime::Now](https://docs.unrealengine.com/4.26/en-US/API/Runtime/Core/Misc/FDateTime/Now/)
[^22]: [한국천문연구원. 보도자료. 2023년 12월 31일 일몰 및 2024년 1월 1일 일출시각 발표](https://www.kasi.re.kr/kor/publication/post/newsMaterial/29876)