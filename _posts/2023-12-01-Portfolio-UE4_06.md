---
layout: post
title: 사무용 노트북으로도 작업가능한 최적화기법
date: 2023-12-1
category: 
 - portfolio
 - p-UE4
tag:
 - 1|최적화
 - 1|Merge-Mesh
 - 1|HLOD
 - 1|CullDistanceVolume
thumbnail: /style/image/portfolio_thumbnails/UE4/RenderOpt.png
icon: game
---

고사양 레벨 애셋 사용을 위한 언리얼의 다양한 랜더링 프로파일링 기능 총정리 및 최적화 적용사례 기록  

* content
{:toc}

## 요약

- 주요 문제 : 고사양을 요구하는 백그라운드 애셋 적용 시 심각한 프레임드랍으로 작업진행 어려움
- 해결 방안 :  
    1. `LOD`와 `HLOD`를 활용해 비용절감,  
    2. `Cull Distance Volume` 활용 카메라 거리에 따른 소형애셋 드로우 조정  
- 그 외 방법들 :  
    1. 에디터 그래픽 설정 변경  
    2. HierachicalInstancedStaticMesh을 통한 드로우 수 절감  
    3. Texture LOD bias 설정 조율로 적절한 텍스처 해상도 적용  
    4. Light Draw Distance로 거리에 따른 다이나믹 라이트 랜더 조율  
    5. 다이나믹 라이트의 Cascaded Shadow Map 설정으로 비용절감  
    6. Mesh Merge로 드로우콜 감소  
- 이루어낸 성과 :  
    1. 작업환경에 제한받지 않는 최적화 기법으로 작업 완료  
    2. 추후 레벨 애셋 적용시 필요한 최적화 방법을 탐색할 수 있는 plugin 제작  

---
1. 작업환경 주요 SPEC  

    | CPU | GPU |
    | :---: | :---: |
    | intel i7 4코어 6스레드 | 내장 |

2. 사용한 애셋 정보  
    ![image](https://github.com/user-attachments/assets/7b171374-dee5-418e-b897-6d9bbd9c428b)  

    기술 세부사항  
    - 500 ~ 5000 tri수를 가진 매쉬가 대부분이며 최대 350,000까지 있음  
    - 텍스처 해상도 4096 x 4096  

    고사양 컴퓨터에서 사용을 권장한다는 문구가 그제서야 눈에 들어온다..  
    > This pack is almost 10GB in size  
    and with all features enabled is recommended for higher-end PC's.  
    All features are recommended for highest quality results  

3.  레벨 애셋 적용 후 랜더링 상태   

    | 프로젝트 크기 | Draw Call Mesh | Triangles Drawn | FPS |
    | :---: | :---: | :---: | :---: |
    | 12.5GB (+8GB) | 1,873.35 | 31,505,818 | 130ms (약 7.6 fps) |

    프로젝트 자체 볼륨도 커져 파일 실행에 몇십분이 걸리는 상황이라 진행이 어려워졌다.  

    > 도대체 어느정도여야 할까? 기준 수치가 있을까?  

    사실 에디터 프레임드랍으로 체감하기 전까진 Tri의 수나 각 텍스처의 무게 등이 얼마나 무거운지 알 수 없었다.  
    상용화되는 게임이 어디까지 최적화 되어있는지 직접 해부해보고 싶은 마음에 [에픽게임즈의 교육용 컨텐츠](https://www.fab.com/ko/listings/d813ecef-8346-4d8c-9484-169da72a80aa)를 
    열어보았고 그제서야  
    나의 프로젝트가 얼마나 처참한 수준인지 알 수 있었다.  

    | 프로젝트 크기 | Draw Call Mesh | Triangles Drawn | FPS |
    | :---: | :---: | :---: | :---: |
    | 7.2GB | 3,344 | 12,541,438 | 22.8ms (약 43 fps) |

    *이렇게 엄청난 디테일과 고퀄의 레벨을 멀쩡히 돌릴 수 있게 해주다니..!*  
    ![image](https://github.com/user-attachments/assets/ccc51cfd-1932-40eb-a3a1-36337201f6ee)  

    에디터 그래픽 설정으로 응급치료를 해두고, 가벼운 레벨에서 최적화 방법을 찾아 하나씩 적용해보았다.  

---

## 랜더링 비용 확인방법

[언리얼엔진 문서](https://dev.epicgames.com/documentation/ko-kr/unreal-engine/optimizing-and-debugging-projects-for-real-time-rendering-in-unreal-engine) [^11] 를
통해 개념을 이해하고, 각종 유튜브 [^12] [^13] [^14] 로 실제 적용사례를 공부했습니다.  

| 구분 | 이름 | 내용 | 참고할 정보 |
| :---: | :---: | :---: | :---: |
| cmd | stat unit & unitgraph | 밀리초단위 프레임 수와 영향을 주는 요소 | CPU 게임 스레드, CPU 렌더 스레드, GPU |
| cmd | stat scenerendering | 뷰포트의 랜더링정보 통계자료 조회 | Mesh draw calls : 드로우콜 수 |
| cmd | stat RHI | RHI 메모리 및 퍼포먼스 통계 | Triangles drawn : 폴리곤 수 |
| 뷰포트 | 쿼드오버드로 | 오버드로우 픽셀 복잡도 표시 | 중첩되어 낭비되는 픽셀에셋 확인 |
| 뷰포트 | 필요텍스처해상도 | 거리에 따른 최적의 해상도 적정여부 확인 | 불필요한 고해상도 텍스쳐 조율 |
| 창 | 통계 | 프리미티브 관련 데이터 통계 확인 | 상위 Tri오브젝트 조회 |
| 콘텐츠브라우저 | 사이즈맵 | 각 파일의 용량 정보 확인 | 상위 크기의 애셋 확인 가능 |
| 시각화 툴 | GPU Visualizer | GPU작업 과정을 시각화 | 최적화필요 과정 확인 |

+ CPU, GPU사용량 확인
    런타임, 에디터에서 확인 가능하며 에디터에선 STAT표시 토글 : Shift+L 가능  
    \`cmd 호출 > `stat unit` `stat unitgraph`
    <img align="center" width="500" src="https://github.com/user-attachments/assets/be027a3c-d67f-4e46-b4e5-0c9c495b710d">  
    
    FrameRate에 직접적인 영향을 주는 3개의 평행스레드 :

    |구분|스레드명|내용|DX프레임워크에서의 유사과정|
    |:---:|:---:|:---:|:---:|
    | CPU | Game | C++, 블루브린트의 게임로직 실행 | Scene의 Update 단계 |
    | CPU | Draw | 오브젝트들의 정점정보와 Shader, Culling 등<br>계산을 마친 뒤 GPU에 전달 및 DrawCall | 랜더링 파이프라인, Device와 DC가 하는 일들 |
    | GPU | GPU | Draw스레드에서 전달받은 정보로 픽셀 표현 | Draw 단계 |

    한 프레임에 소요되는 시간은 각 스레드에서 소요된 시간의 합이며,  
    각 스레드의 작업이 끝나면 곧바로 다음 프레임에 대한 작업을 진행한다.  
    현재 내 프로젝트는 Draw스레드로부터 받은 정보를 처리하는 GPU스레드에서 심각하게 많은 시간이 소요되고 있음을 알 수 있다.  
    <br>

+ 뷰포트에서의 DrawCall / Triangles Drawn 확인  
    \`cmd 호출 > `stat scenerendering`
    ![스크린샷 2024-11-16 035630](https://github.com/user-attachments/assets/88a9b40f-da3f-4d16-ba06-bfa9645e5d90)   
    \`cmd 호출 > `stat RHI`  
    ![스크린샷 2024-11-16 035544](https://github.com/user-attachments/assets/1b01076e-2a28-4110-90bf-dada2bf7984e)  



+ 프리미티브 통계정보 확인  
    창 > 통계
    ![image](https://github.com/user-attachments/assets/e5cbee11-a5b0-42b1-80b0-1dcb00f9cd51)  

---

## ✨LOD & HLOD  

우선 가장 시급해보이는 tri수를 줄이기 위해 Mesh의 LOD를 조절했다.  

### Mesh LOD 설정  



### HLOD 설정  

### Nanite  

## ✨Cull Distance Volume

## 그 외 방법들

### 에디터 그래픽 설정 
### Texture LOD bias 설정
### Light Draw Distance
### Directional Light Cascaded Shadow Map
Dynamic Shadow Distance Movalble Lights
### Mesh Merge

## 생각정리

> 엔진 5이상으로 버전업을 하면 하지 않아도 될 고생..  
좀 더 가벼운 레벨애셋으로 새로 적용하면 어떨까요?  
솔직히 사무용 노트북으론 너무 과한 작업이니 PC를 새로 구매하는게 어떨까요..?  

이미 애니메이션 때문에 한땀한땀 과정을 옆에서 지켜본 동기들이 해준 말이었다.  
작업속도도 느려지고 의미없는 고생을 사서하는건가 싶었지만, 성능최적화를 제대로 배워보는 시간을 가져보자는 마음으로 깊게 파고들었다.  

*이런 기능도 있었네! 어떻게 적용되는 거지?*  
꼬리에 꼬리를 물며 나와 내 작업물에 가장 필요한 부분을 적절히 사용할 줄 알게됐고, 이 후에 어떤 무거운 레벨을 적용해도 필요한 최적화방법을 빠르게 적용할 수 있겠다는 자신감도 생겼다.  

## Reference

[^11]: [Unreal Engine. Unreal Engine Documentation. 실시간 렌더링을 위한 프로젝트 최적화 및 디버깅](https://dev.epicgames.com/documentation/ko-kr/unreal-engine/optimizing-and-debugging-projects-for-real-time-rendering-in-unreal-engine)  
[^12]: [Unreal Engine. YouTube. Profiling and Optimization in UE4 \| Unreal Indie Dev Days 2019 \| Unreal Engine](https://www.youtube.com/watch?v=EbXakIuZPFo)
[^13]: [문브러쉬(2023.1.12). YouTube. 언리얼엔진 드로우콜 확인하기](https://youtu.be/maHHsDd3j5A?feature=shared)  
[^14]: [Matt Aspland. YouTube. How To Find What Is Killing Your Performance In Unreal Engine 5](https://www.youtube.com/watch?v=p0zireudi3U)

[Unreal Engine. Unreal Engine Documentation. LOD 생성 및 사용](https://dev.epicgames.com/documentation/ko-kr/unreal-engine/creating-and-using-lods?application_version=4.27)  
[Unreal Engine. Unreal Engine Documentation. 자동 LOD 생성 셋업](https://dev.epicgames.com/documentation/ko-kr/unreal-engine/setting-up-automatic-lod-generation?application_version=4.27)  
[Unreal Engine Documentation. Cull Distance Volume](https://dev.epicgames.com/documentation/ko-kr/unreal-engine/cull-distance-volume?application_version=4.27)
[Unreal Engine. Unreal Engine Documentation. Mesh Drawing Pipeline](https://dev.epicgames.com/documentation/en-us/unreal-engine/mesh-drawing-pipeline?application_version=4.27)